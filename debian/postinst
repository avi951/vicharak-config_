#!/bin/sh
set -e

BASE_URL="http://pkg.vicharak.in"
LIST_FILE="/etc/apt/sources.list.d/vicharak.list"

OS_CODENAME=$(grep -E "^VERSION_CODENAME=" /etc/os-release | cut -d= -f2)

echo "  -> OS Codename: $OS_CODENAME"

# -------------------------
# Detect hardware
# -------------------------
if [ ! -f /proc/device-tree/compatible ]; then
    echo "[ERROR] /proc/device-tree/compatible not found"
    exit 1
fi

COMPATIBLE="$(tr -d '\0' < /proc/device-tree/compatible)"
echo "  -> compatible: $COMPATIBLE"

# -------------------------
# Detect processor
# -------------------------
if echo "$COMPATIBLE" | grep -qi rk3588; then
    PROCESSOR="rk3588"
    SOC_VENDOR="rk"
elif echo "$COMPATIBLE" | grep -qi rk3399; then
    PROCESSOR="rk3399"
    SOC_VENDOR="rk"
else
    echo "[ERROR] Unsupported processor"
    exit 1
fi

echo "  -> Processor: $PROCESSOR"

# -------------------------
# Detect device
# -------------------------
if echo "$COMPATIBLE" | grep -qi axon; then
    DEVICE="axon"
elif echo "$COMPATIBLE" | grep -qi vaaman; then
    DEVICE="vaaman"
else
    DEVICE="generic"
fi

echo "  -> Device: $DEVICE"

# -------------------------
# Write APT source
# -------------------------
echo "[INFO] Writing APT sources to $LIST_FILE"

cat > "$LIST_FILE" <<EOF
# OS      : $OS_CODENAME
# CPU     : $PROCESSOR
# Device  : $DEVICE

deb $BASE_URL stable stable
deb $BASE_URL stable-${SOC_VENDOR}main stable-rockchip/rkmain
deb $BASE_URL stable-$PROCESSOR-main stable-rockchip/$PROCESSOR/main
deb $BASE_URL stable-$PROCESSOR-$DEVICE-main stable-rockchip/$PROCESSOR/$DEVICE/main
deb $BASE_URL stable-$PROCESSOR-$DEVICE-ubuntu-main stable-rockchip/$PROCESSOR/$DEVICE/ubuntu/main
deb $BASE_URL stable-$PROCESSOR-$DEVICE-ubuntu-$OS_CODENAME stable-rockchip/$PROCESSOR/$DEVICE/ubuntu/$OS_CODENAME
EOF

apt update

exit 0
